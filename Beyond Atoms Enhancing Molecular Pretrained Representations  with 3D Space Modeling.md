# Beyond Atoms: Enhancing Molecular Pretrained Representations  with 3D Space Modeling

# 摘要

分子预训练表示（MPR）已成为解决药物发现和材料设计等应用中监督数据有限这一挑战的有力方法。早期的MPR方法依赖于一维序列和二维图，而近期的进展则整合了三维构象信息，以捕捉丰富的原子间相互作用。然而，这些先前的模型仅仅将分子视为**离散的原子集合**，忽略了它们周围的空间。我们从物理视角指出，仅对这些离散点进行建模是不够的。我们首先提出一个简单却具洞察力的观察：在原子之外随机地添加随机采样的虚拟点，竟能显著提升MPR的性能。基于此，我们提出了一个系统性的框架，该框架整合了分子所跨越的整个三维空间。我们通过一种新颖的基于 Transformer 的架构来实现这一框架，将其命名为 SpaceFormer，它包含三个关键组件：（1）基于网格的空间离散化；（2）网格采样/合并；（3）高效的三维位置编码。大量实验表明，在数据有限的情况下，SpaceFormer 在各类下游任务中显著优于以往的三维 MPR 模型，验证了在 MPR 模型中利用原子之外的额外三维空间的益处。

# 背景

## 研究背景与问题动机

- **分子预训练表示（MPR, Molecular Pretraining Representation）** 已成为药物设计与材料发现中的关键研究方向。

- 由于**实验和模拟获得标注数据成本高昂**，小规模数据集难以支撑高性能模型。

- MPR 的核心思想是：

  > 在大规模**无标签分子数据**上进行预训练 → 学习通用分子表示 → 在**有限标签数据**上微调以提升性能。

## 基于原子建模的局限性

尽管原子级建模直观有效，但存在以下**物理层面的局限**：

1. 模型只关注**原子之间的关系**，忽视了**原子之外的空间**；
2. 实际上，所谓“空”的空间中包含：
   - 电子云分布；
   - 电磁场；
   - 量子涨落等物理现象；
3. 分子的重要性质（如**电子密度分布**、**势场分布**）是定义在整个三维空间上的，而非仅依赖于原子位置。

> 因此，提出关键问题：“如果对原子之外的三维空间进行显式建模，是否能提升分子预训练表示的能力？”

![image-20251023143115373](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023143115373.png)

为了验证这一假设，我们从一个简单的实验开始。给定一个分子的点集，我们在分子周围空间内引入随机采样的虚拟点（VPs），并将增强后的点集输入到现有的三维 MPR 模型中。令人惊讶的是，即使这些 VPs 本质上是噪声且理论上不携带任何有意义的信息，添加少量 VPs 后仍观察到显著的性能提升。值得注意的是，随着 VPs 数量的增加，这种改进保持一致并逐渐增强，最终达到平台期（见图 2）。

实验结果说明：

- 传统仅以“原子集合”为输入的建模方法过于局限；
- 分子周围空间（包括“空”区域）中可能隐含结构或物理规律；
- 因此，需要一种能**直接对整个三维空间建模**的原则性方法。

为此，我们提出了一种根本不同的 MPR 框架：将分子看作一个**三维图像（3D image）**，显式地表示其在空间中的分布。

1. 将分子所在的三维空间**离散化为小的网格单元**（voxels）；

2. 保证每个网格单元**至多包含一个原子**；

3. 为每个单元定义输入特征，包括：

   - 网格位置；

   - 若存在原子，则记录其类型与坐标；

4. 使用 Transformer 等能处理集合输入的模型，对所有网格单元进行学习。

实现了从仅关注“原子间关系”向**全空间结构建模**的转变，使模型能够捕获更全面的分子几何与物理特征。

## 高效实现

![image-20251023145357749](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023145357749.png)

 上述框架的一个潜在缺点在于其效率。事实上，随着单元长度的减小，网格单元的数量会呈立方级增长，这限制了其可扩展性。为解决此问题，我们实现了两种直观的策略来显著减少单元数量。第一种是**网格采样**，即随机选择一部分空网格单元；第二种是**自适应网格合并**，即将相邻的空单元递归地合并成更大的单元（见图 1）。这两种方法在实践中均表现良好，能在保持性能的同时将单元数量减少约一个数量级。此外，我们设计了基于 RoPE（Su 等，2024）和随机傅里叶特征（Rahimi & Recht, 2007）的高效版本成对位置编码，其复杂度相对于单元数量呈线性关系。我们将最终得到的架构称为 **SpaceFormer**。

## 预训练方法

 我们所提出的框架的一个关键优势在于，它可以与一种强大的预训练方法——掩码自编码器（MAE）相结合。具体而言，在预训练阶段，我们可以对每个分子的一部分网格单元进行掩码，并让模型预测每个被掩码的单元是否包含原子。如果是，则模型会进一步预测该原子的类型及其在单元内的精确位置。值得注意的是，我们的分析揭示了 MAE 预训练相较于现有方法（如去噪方法 Zaidi 等，2022）的一个潜在优势，表明模型可能通过掩码预测学习到额外的知识。

我们进行了广泛的实验以评估 SpaceFormer 的有效性和效率。在总计 15 个不同的下游任务中，SpaceFormer 在 10 个任务上取得了最佳性能，并在 14 个任务中排名前二。消融研究进一步证实，每个组件都在提升 SpaceFormer 的性能或效率方面发挥着关键作用。总体而言，这些结果强调了对原子位置之外的三维空间进行建模的重要性，我们相信我们的框架可以作为一种新的范式，推动 MPR 领域的发展。

# 3. 方法

## 3.1 动机：添加虚拟点的效果

我们提出对原子以外的周围空间进行建模，以增强三维分子预训练表示（MPR），因为这有助于捕捉电磁场和量子效应等关键物理特征。为验证该假设，我们设计了一个激励性实验：给定一个由原子集合表示的分子，在其包围的长方体空间内随机采样并引入若干虚拟点（VPs），将增强后的点集输入到当前最先进的三维 MPR 模型 Uni-Mol 中。实验遵循原始 Uni-Mol 的预训练流程，即随机掩码原子类型并在位置上添加高斯噪声，同时训练模型预测真实类型与噪声值。

![image-20251023150040221](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023150040221.png)

结果显示（见图 2），添加少量随机 VPs 即显著改善了验证损失；随着 VPs 数量增加，性能持续提升并最终趋于稳定。令人意外的是，这些完全随机、理论上不携带物理信息的虚拟点，仍能稳定地提高模型表现，且改进并非仅由于计算量增加所致。

这一实验验证了建模分子周围空间的潜力，并引出了进一步问题：是否可以通过更系统、原则化的方法对整个三维空间进行建模，以实现更优的表示学习？为此，我们在下一节提出一种直接对三维空间建模的新框架。

## 3.2 框架概览

我们的方法受到计算机视觉中标准输入形式的启发——图像通过在连续二维空间中均匀采样并离散化为像素网格进行表示。类似地，我们将分子的三维空间离散化为小而均匀的网格单元，以形成规则的三维“体素”表示。相比于第 3.1 节中随机采样虚拟点的方式，这种基于网格的采样能够确保对三维空间的**均匀覆盖**，从而更系统地建模空间结构。

为确定合适的网格分辨率，我们引入了一个基本的物理约束：由于排斥作用，任意两个不同原子之间存在最小分离距离 $\hat{d}$。因此，只要网格单元的边长 $c^l$ 满足 $c^l < \frac{\hat{d}}{\sqrt{3}}$ 即可保证离散化精度充足，使每个网格单元最多包含一个原子。该最小距离 $\hat{d}$ 一般为任务无关常数；对于小型有机分子，$\hat{d} \approx 0.96\mathring{A}$（约为 O–H 键长）。在本文实验中，我们固定单元长度为 $c^l = 0.49\mathring{A}$。

### 数据增强

我们采用了两种简单的数据增强类型。首先，在离散化之前，我们随机旋转分子以增强模型对旋转的鲁棒性。其次，在离散化之后，我们随机在网格边界每一面填充最多 2 个网格单元，以确保原子周围的扩展空间能够捕捉更广阔的上下文空间。

### 输入格式

基于离散化，我们框架的输入仅仅是网格单元的集合，其中每个单元由两部分组成：其类型和坐标。由于每个网格单元最多包含一个原子，因此这些单元可以被分类为原子单元或非原子单元。对于每个原子单元，其类型和坐标被定义为原子类型及其精确的三维坐标。对于每个非原子单元，我们为其分配特殊类型 NULL，并将其坐标定义为其单元中心。在下文中，我们将使用 $t_i$ 和 $c_i \in \mathbb{R}^3$ 分别表示第 $i$ 个单元的类型和坐标。这些坐标将在后续的嵌入层以及 Transformer 层中的相对位置编码中进一步处理。

### 嵌入

给定每个表示为 $(t_i, c_i)$ 的单元，我们通过以下嵌入层对其进行处理。首先，我们计算原子（或非原子单元的单元中心）在单元内的内部位置，定义为 $\tilde{e}_i = c_i \mod c^l$，然后进行离散化 $e_i = \lfloor \frac{\tilde{e}_i}{c^m} \rfloor$，其中 $c^m$ 是一个设置为非常小值的超参数，即 $c^m = 0.01\mathring{A}$。这样，得到的 $e_i$ 就是一个元素范围在 $\left[0, \frac{c^l}{c^m}\right)$ 内的整数向量。接下来，我们将所有离散输入特征 $a_i := (t_i, e_i) \in \mathbb{N}^4$ 通过求和相应的嵌入层转换为连续特征表示，即 $x_i = \sum_{t=1}^{4} \text{Embed}_t(a_{i,t})$，其中 $\text{Embed}_t(\cdot)$ 是将离散输入映射到连续表示的参数化嵌入函数，$x_i$ 是第 $i$ 个单元的最终输入嵌入。

### 架构

给定输入特征集 $\{x_i\}$，我们可以使用任何能够处理集合的模型来处理它，特别是 Transformer 架构。我们将由此产生的模型称为 SpaceFormer。然而，SpaceFormer 的朴素应用会面临显著的计算成本，因为其复杂度随网格单元数量呈二次方增长，而这在离散化过程中可能相当可观。例如，在广泛使用的有机分子数据集 ZINC 中，平均单元数约为 8,000。这种高成本可以通过使用先进的注意力实现（如 FlashAttention）来部分缓解，本文也采用了该技术。然而，其成本仍高于之前的基于原子的方法。

## 3.3 网格采样与合并

为了降低计算成本，一个直接的方向是减少非原子单元的数量。我们提出了两种直观的策略来实现这一目标，如下所述。

### 网格采样

在此策略中，我们仅随机选择一部分非原子网格单元，并将所选单元连同所有原子单元一起输入模型。经验表明，即使仅采样 10%-20% 的非原子单元，该策略已能很好地工作。

### 自适应网格合并

![image-20251023151618767](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023151618767.png)

上述采样策略的一个潜在局限性在于，它并未融入基本的物理原理，并且涉及调优一个额外的超参数。具体而言，在量子物理中，靠近原子的区域通常表现出更高的电子密度，且这些区域内的密度会随位置显著变化。相反，远离所有原子的区域通常电子密度趋近于零。因此，计算模拟通常在原子附近采用细粒度采样以精确捕捉这些动态变化，而在远处区域则采用粗粒度采样以优化计算效率。受此方法启发，我们引入了一种自适应网格合并策略，如图 3 所示。具体而言，从完整的网格单元开始，我们将它们按 $2 \times 2 \times 2$ 的块进行分组，如果某个块中的八个相邻单元均为非原子单元，则将其合并为一个“更大”的单元。此过程可以递归执行直至收敛。合并后，每个合并单元的坐标仍被定义为其单元中心，而其类型将进一步区分单元大小（或合并层级）。经验上，我们发现该策略可以在无需调优任何超参数的情况下，将网格单元数量减少一个数量级，同时保持性能不变。

## 3.4 高效的三维相对位置编码

位置编码（PE）在基于 Transformer 的模型中至关重要，因为原始的 Transformer 架构对其输入结构缺乏归纳偏置。虽然绝对位置信息通常直接注入输入，但相对 PE 同样重要，因为它捕捉了网格单元之间的成对关系。然而，朴素地集成相对 PE 由于其相对于网格单元数量的二次方内存成本而计算效率低下。当与 FlashAttention 结合时，这种低效性尤其不切实际。

为解决此问题，我们提出了一种专为连续三维坐标设计的高效位置编码方法。给定三维空间中的两点 $A$ 和 $B$，分别记其坐标为 $c_A$ 和 $c_B$。相对位置信息可定义为向量 $\overrightarrow{AB} := c_B - c_A$。在下文中，我们提出两种线性复杂度的三维位置编码：第一种直接编码 $\overrightarrow{AB}$，以捕捉原始的方向信息；第二种编码几何距离 $\|\overrightarrow{AB}\|_2$，这是在坐标系变换下的一个基本不变量。

### 使用 RoPE 的三维方向 PE

近期，旋转位置编码（RoPE）因其在线性复杂度下编码相对位置的能力而广受欢迎。在此，我们将 RoPE 扩展到三维连续空间，以编码方向信息 $\overrightarrow{AB}$，从而捕捉所有三个轴上的成对方向关系。

回顾可知，在 RoPE 中，第 $i$ 个 token 的 Query 向量和第 $j$ 个 token 的 Key 向量在执行点积注意力之前，会乘以一个二维位置感知的旋转矩阵，其形式如下：
$$
(\boldsymbol{R}(i)\boldsymbol{q}_i)^\top (\boldsymbol{R}(j)\boldsymbol{k}_j) = \boldsymbol{q}_i^\top (\boldsymbol{R}(i)^\top \boldsymbol{R}(j)) \boldsymbol{k}_j \\
= \boldsymbol{q}_i^\top \boldsymbol{R}(j-i) \boldsymbol{k}_j,
$$
其中 $q_i$ 是第 $i$ 个 token 的 Query 向量，$k_j$ 是第 $j$ 个 token 的 Key 向量，$R(i)$ 是一个 $d \times d$ 的旋转矩阵，其参数 $\theta_1, \cdots, \theta_{d/2}$ 定义如下：
$$
\boldsymbol{R}(i) =
\begin{bmatrix}
\cos i\theta_1 & -\sin i\theta_1 & & \\
\sin i\theta_1 & \cos i\theta_1 & & \\
& & \ddots & \\
& & & \cos i\theta_{d/2} & -\sin i\theta_{d/2} \\
& & & \sin i\theta_{d/2} & \cos i\theta_{d/2}
\end{bmatrix}.
$$

为了将 RoPE 扩展到三维连续空间，我们将每个 Query 和 Key 向量拆分为 3 个块，并分别为每个块应用一个旋转矩阵。形式上，
$$
\left(
\begin{bmatrix}
\boldsymbol{R}(c_{i,1}) & & \\
& \boldsymbol{R}(c_{i,2}) & \\
& & \boldsymbol{R}(c_{i,3})
\end{bmatrix}
\begin{bmatrix}
\boldsymbol{q}_{i,1} \\
\boldsymbol{q}_{i,2} \\
\boldsymbol{q}_{i,3}
\end{bmatrix}
\right)^\top
\left(
\begin{bmatrix}
\boldsymbol{R}(c_{j,1}) & & \\
& \boldsymbol{R}(c_{j,2}) & \\
& & \boldsymbol{R}(c_{j,3})
\end{bmatrix}
\begin{bmatrix}
\boldsymbol{k}_{j,1} \\
\boldsymbol{k}_{j,2} \\
\boldsymbol{k}_{j,3}
\end{bmatrix}
\right)
\\
= \sum_{s=1}^{3} \boldsymbol{q}_{i,s}^\top \boldsymbol{R}(c_{j,s} - c_{i,s}) \boldsymbol{k}_{j,s}.
$$
通过这种方式，每个轴的方向信息通过 $R(c_{j,s} - c_{i,s})$ 在 Transformer 层中被编码。

### 使用 RFF 的三维距离 PE

几何距离是量子力学中成对相互作用的一个基本度量。为了克服计算成对距离所关联的二次方内存开销，我们提出使用随机傅里叶特征（RFF）来近似高斯核，其形式如下：
$$
\exp\left(-\frac{\|\boldsymbol{c}_i - \boldsymbol{c}_j\|^2}{2\sigma^2}\right) \approx z(\boldsymbol{c}_i)^\top z(\boldsymbol{c}_j),\\
z(\boldsymbol{c}_i) = \sqrt{\frac{2}{d}} \cos\left(\frac{\boldsymbol{c}_i^\top \boldsymbol\omega}{\sigma} + \boldsymbol{b}\right),\\
\boldsymbol\omega \in \mathbb{R}^{3 \times d} \sim \mathcal{N}(\boldsymbol{0, I}),\quad \boldsymbol{b} \in \mathbb{R}^d \sim \mathcal{U}([0, 2\pi)^d)
$$
这里，$\sigma$ 控制高斯核的带宽，$\boldsymbol\omega$ 的每个元素都是从标准正态分布中独立同分布（i.i.d.）采样的，而 $\boldsymbol{b}$ 是从 $[0, 2\pi)^d$ 上的均匀分布中采样的。

随机傅里叶特征随后在应用 RoPE 后与 Query 和 Key 结合：
$$
\tilde{\boldsymbol{q}}_i = [\boldsymbol{q}_i^\top, z(\boldsymbol{c}_i)^\top]^\top, \quad \tilde{\boldsymbol{k}}_j = [\boldsymbol{k}_j^\top, z(\boldsymbol{c}_j)^\top]^\top.
$$

此处，拼接确保了 RoPE 和 RFF 的效果是分离的，即 $\tilde{\boldsymbol{q}}_i^\top \tilde{\boldsymbol{k}}_j = \boldsymbol{q}_i^\top \boldsymbol{k}_j + z(\boldsymbol{c}_i)^\top z(\boldsymbol{c}_j)$。

## 3.5 预训练

我们所提出的框架的一个关键优势在于，它支持一种强大且高效的预训练方法，即掩码自编码器（MAE）。在 MAE 中，我们随机掩码一部分（原子或非原子）网格单元，并仅将剩余的单元输入到 SpaceFormer 中以获得这些单元的表示。然后，我们使用另一个解码器架构，该架构以这些表示以及所有被掩码的单元作为输入，来预测它们的类型和坐标。MAE 方法效率极高，因为 (1) 编码器仅在未被掩码的单元上运行，(2) 解码器（其输入为所有单元）比编码器小得多。

**实现细节。** 尽管上述预训练框架很直接，但一些实现细节使其区别于图像预训练，我们在下文重点说明。首先，我们必须对原子单元和非原子单元的预测进行差异化处理。请注意，被掩码单元的输入坐标由其中心位置定义。因此，如果一个单元被预测为原子单元，模型必须额外预测其相对于单元中心的偏移量。此外，由于原子单元和非原子单元的数量高度不平衡，我们为每种单元类型的预测分配不同的损失权重，以确保它们的整体贡献是平衡的。其次，在将 MAE 与自适应网格合并结合时需谨慎，因为对已合并的网格进行掩码没有意义（因为它可以被轻易预测）。相反，掩码过程应在自适应网格合并之前应用，之后在编码器中排除所有被掩码的单元。

**与先前预训练流程的比较。** 在文献中，大多数先前的 MPR 方法都基于去噪。我们认为，我们的基于 MAE 的预训练可能更具优势，因为它涉及一个更强的训练任务，有助于模型在预训练期间获取额外的知识。具体而言，MAE 中的预测任务可以分解为两个部分：第一部分涉及预测某个原子是否存在于三维空间的特定范围内，而第二部分则细化相对于网格中心的精确坐标。可以看到，第二部分正是“去噪”的一种形式，而第一部分在基于去噪的方法中是缺失的。此外，与去噪不同的是，后者会扰动某些原子，而我们则是完全移除它们，使预训练任务更加困难。我们假设这些差异促成了性能的提升，这将在下一节中得到证明。

# 4. 实验

为了评估我们提出的 SpaceFormer，我们首先在大规模无标签数据上进行**无监督预训练**，然后在各种有限标签数据的任务上进行**微调**。此外，我们进行了广泛的**消融**研究，以评估其关键组件的贡献。最后，我们将 SpaceFormer 的**有效性和效率**与那些结合了虚拟点的基于原子的 MPR 模型进行了比较。

## 4.1 设置

**预训练设置。** 我们使用与 Zhou 等人 (2023) 相同的预训练数据集，该数据集共包含 1900 万个分子。预训练设置的详细信息见附录中的表 5。对于网格合并，我们将合并层级设为 3，这对应于收敛状态。此配置生成了一个约含 6780 万（编码器）参数的模型，并在 8 块 NVIDIA A100 GPU 上需要约 50 小时的训练时间。

**基线模型。** 我们的主要基线是 Uni-Mol，这是一个近期的三维 MPR 模型，在广泛的分子性质预测任务中取得了最先进的性能。我们使用与 Uni-Mol 相同的预训练数据集以确保公平比较。我们还纳入了 Mol-AE，它是在 Uni-Mol 基础上扩展了（基于原子的）MAE 预训练。为了进行更全面的比较，我们进一步纳入了 3D Infomax——一种融合了三维信息的图神经网络（GNN）表示模型，以及两个基于二维图的 MPR 模型：GROVER 和 GEM。

**下游任务。** 我们开发了一个新的基准，以全面评估 MPR 模型，特别是关注有限数据场景下的表现。我们的基准包含两类任务：分子计算属性和分子实验属性。对于计算属性，我们从庞大的 GDB-17 数据集中采样一个 20K 的子集，并选择电子属性 HOMO、LUMO 和 GAP。此外，我们从同一数据集中采用另一个 21K 子集 (Ramakrishnan 等, 2015)，选择能量属性 E1-CC2、E2-CC2、f1-CC2 和 f2-CC2。此外，我们整合了 Wahab 等人 (2022) 提供的数据集，该数据集包含 1 至 11 个环的缩合多苯烃，共 8k 个样本，并从中选取分子内及分子间的力学和电子属性，如 Dipmom、aIP 和 D3 分散校正 (D3_disp_corr)。对于实验属性，我们选用了来自 MoleculeNet 的 BBBP 和 BACE 数据集，并确保排除所有重复和结构无效的分子。此外，我们采用了来自 Biogen ADME 数据集的 HLM、MDR1-MDCK ER (MME) 和溶解度 (Solu) 数据集。这些任务的详细描述如下表所示：

![image-20251023194000614](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023194000614.png)

在所有任务中，数据集均按 8:1:1 的比例划分为训练集、验证集和测试集。我们应用了分布外划分方法，即根据骨架相似性来划分数据集。这最终形成了 15 个任务，以便进行全面评估。我们确保超参数搜索空间在所有任务和基线模型中保持一致（如下表）。

![image-20251023194056493](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023194056493.png)

对于每组超参数，我们使用不同的随机种子训练每个模型 3 次，并报告平均结果和标准差。所有实验均选用验证损失最佳的检查点。

## 4.2 结果

![image-20251023194226725](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023194226725.png)

表 1 展示了我们的实验结果。结果清晰地表明，SpaceFormer 表现卓越，在 15 项任务中有 10 项排名第一，在 15 项任务中有 14 项进入前两名。特别是在 HOMO、LUMO、GAP、E1-CC2 和 Dipmom 等计算属性任务上，SpaceFormer 显著优于所有基线模型，其表现比亚军模型高出约 20%。这验证了对原子位置之外的三维空间进行建模的有效性，并证明了 SpaceFormer 设计的合理性。

SpaceFormer 在 BBBP 任务上的效果有限，一个可能的原因是实验属性的测量环境具有复杂性和多变性，这些环境极易受温度和血脑屏障生物膜状态等外部因素的影响。这种可变性可能会影响测量结果的稳定性，导致其无法准确反映真实情况。此外，正如第 4.1 节脚注中提到的，用于实验任务（包括 BBBP）的 MoleculeNet 数据集存在一些局限性，例如包含无效结构和不一致的化学表示，这影响了其区分分子预训练模型的能力。

## 4.3 消融研究

在本小节中，我们进行了一系列实验，以评估 SpaceFormer 所提出的各个组件。我们在所有消融实验中均选择了 HOMO、LUMO、E1-CC2 和 E2-CC2 属性。

![image-20251023194644461](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023194644461.png)

**网格采样/合并的效果。** 如第 3.3 节所述，我们提出了使用随机采样或自适应网格合并来处理非原子单元，以降低训练成本。在此，我们通过改变输入单元的数量来评估这两种方法的效率和性能。对于自适应网格合并，我们尝试了不同的合并层级 $L$。$L=0$ 表示不进行合并（使用完整的网格单元集），而 $L=3$ 表示合并直至收敛。对于随机采样，我们测试了不同的采样比例，并确保采样单元数与不同合并层级下的合并后单元数相匹配，以便直接比较两种方法。结果如表 2 所示，我们可以得出以下结论：

1.  **(No. 1-4)** 随着合并层级数量的增加，模型的效率显著提升，而性能则相对稳定。特别是，“合并至收敛”策略在不牺牲准确性的前提下实现了最佳效率。
2.  **(No. 5-10)** 随着采样比例的降低，模型的效率显著提高。然而，当采样单元数少于 1K 时，性能开始迅速下降。效率与准确性的最佳权衡点出现在采样 800-1K 个网格单元时。
3.  **(No. 2-7)** 总体而言，自适应合并策略的表现略优于随机采样策略，尽管差异并不显著。然而，自适应合并的关键优势在于它无需调优采样比例即可自适应地调整网格单元数量。

![image-20251023194807248](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023194807248.png)

**三维位置编码。** 在本节中，我们评估了第 3.4 节中提出的两种三维位置编码方法的贡献。具体而言，我们考虑了两种设置：(1) 仅使用 RoPE（编号 2），以及 (2) 移除两种位置编码（编号 3）。对于后一种设置，位置信息通过简单地将三维位置 $c_i$ 的线性投影添加到输入嵌入 $x_i$ 中来引入。结果如表 3 所示。我们可以清晰地看到，这两种三维位置编码在提升模型性能方面都扮演着至关重要的角色。

## 4.4 进一步分析

在本小节中，我们通过一组精心设计的实验对 SpaceFormer 进行更深入的分析，如表 4 所示。这些实验可以提供对 SpaceFormer 性能提升背后根源的更深层次见解，并进一步阐明我们的主要贡献。

![image-20251023195000899](./Beyond%20Atoms%20Enhancing%20Molecular%20Pretrained%20Representations%20%20with%203D%20Space%20Modeling.assets/image-20251023195000899.png)

**基础设置。** 我们训练了一个纯粹“基于原子”的 SpaceFormer，即不使用任何非原子单元，并将此设置称为 S1。然后，我们根据表 2 中的编号 10 和编号 4，分别添加了两个设置 S2 和 S3（我们使用 “S” 而非 “No.” 来与之前的表格区分开）。

**关于 FLOPs。** 我们首先检验性能提升是否仅仅源于计算成本（FLOPs）的增加。为此，我们通过将模型宽度从基线设置 S1 扩大 4 倍来训练一个显著更大的 SpaceFormer 模型，从而得到设置 S4。调整模型宽度是为了确保其训练速度略慢于设置 S3。如表 4 所示，尽管扩大模型规模带来了显著的性能提升，但 S4 的结果在大多数下游任务上仍落后于 S3。这表明，所观察到的性能提升并不仅仅是更高计算成本的结果。

**基于原子的模型能否仅通过使用虚拟点达到相似性能？** 我们通过使用基于原子的模型 Uni-Mol 并按第 3.1 节所述改变虚拟点数量来进行一组实验来回答这个问题。这对应于表 4 中的设置 S6-S10。我们可以看到，虽然引入虚拟点可以在若干任务上提升模型性能，但在 UniMol 和 SpaceFormer 之间仍存在显著差距，因此我们的改进不应简单归因于使用了虚拟点。下一个实验将进一步突出另一个差异：MAE 的使用。

**MAE 与去噪。** 如第 3.5 节所述，MAE 对应的预训练任务比去噪更强。为了经验性地观察这一差异，我们设计了一种 MAE 的变体，其中仅掩码原子单元，这样模型就无需预测被掩码的单元是否包含原子。这对应于表 4 中的设置 S5。我们可以看到，在所有四项下游任务中，S3 均优于 S5，从而证实了使用 MAE 预训练的好处。

**随单元数量的可扩展性。** 最后，我们展示了由于我们提出的三维位置编码（PE），该模型在单元数量增加时比 UniMol 具有更好的可扩展性。如图 4 所示，UniMol 的预训练成本随采样单元数量呈二次方增长，而 SpaceFormer 的曲线则趋向于线性形状。这验证了我们所提出的线性复杂度 PE 的效率。

# 总结

本文中，我们引入了 SpaceFormer，这是一种新颖的分子预训练表示（MPR）框架，它通过融入原子位置之外的三维空间来增强分子表示。为了有效且高效地处理三维空间，SpaceFormer 由三个关键组件构成：基于网格的空间离散化、网格采样/合并以及高效的三维位置编码。所得到的框架可以轻松地与 MAE 训练相结合。广泛的实验验证了 SpaceFormer 在各种任务上的有效性和效率。在未来的研究中，一个有前景的方向是将 SpaceFormer 扩展到力场任务和更大的系统，例如蛋白质和复合物。