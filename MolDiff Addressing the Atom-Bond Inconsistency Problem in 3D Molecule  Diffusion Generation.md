# MolDiff: Addressing the Atom-Bond Inconsistency Problem in 3D Molecule  Diffusion Generation

# 1. 摘要

最近，深度生成模型在3D分子生成方面取得了卓越的性能。其中大多数模型首先生成原子，然后在后处理阶段根据已生成的原子添加化学键。然而，由于原子位置是在不考虑潜在化学键的情况下生成的，因此对于这些临时生成的原子，可能不存在对应的成键方案。我们将此问题定义为“原子-键不一致性问题”，并认为这是当前方法生成不现实3D分子的主要原因。为了克服这一问题，我们提出了一种新的扩散模型，称为MolDiff，它能够同时生成原子和化学键，并通过显式建模它们之间的依赖关系来保持二者的一致性。我们使用与几何和化学性质相关的标准评估了所提出模型的生成能力和所生成分子的质量。实证研究表明，我们的模型优于以往的方法，在成功率上实现了三倍的提升，并能生成质量显著更高的分子。

# 2. 背景

#### 研究背景与问题

小分子药物通过与蛋白质特定三维结合口袋相互作用来发挥生物学功能。近年来，药物设计从二维分子图向**三维结构生成**转变，研究者利用深度学习模型生成：

- 多样化的三维分子构象
- 能直接与特定蛋白结合的分子

![image-20251029192733848](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251029192733848.png)

**现有问题**：当前三维药物生成模型生成的分子往往缺乏真实性。多数模型采用“两步式”生成：先生成原子，再查表补充化学键。这种方式带来两类核心问题：

1. **拓扑不合理性**：生成超大环、价态违规等结构，如图1(a,b)；
2. **键预测偏差**：微小噪声会导致查表失败，破坏芳香键等真实连接关系，如图1c。

此外，化学键长度并非单纯由原子距离决定，不同环境下同类型键的长度会变化，增加建模难度。

#### 研究动机

现有方法忽视“原子-化学键信息的耦合”，导致生成的三维结构**化学一致性差**、**鲁棒性低**。

后处理式的键恢复在复杂分子上尤其困难（如 EDM 模型在 GEOM-Drug 上性能下降）。

因此，迫切需要一种**能够在扩散过程中同时建模原子与化学键**的三维分子生成机制，以提升分子的物理化学合理性与真实性。

#### 贡献

1. **提出 MolDiff**：一种基于扩散概率模型的三维分子生成方法，能**同时采样原子与化学键**。
2. **多层噪声扰动策略**：对原子与化学键施加不同级别噪声，保证训练过程中的键长合理性。
3. **键引导的原子生成机制**：在扩散过程中，引入来自键预测器梯度的指导，使原子生成更契合潜在的键结构。
4. **E(3)-等变神经网络结构**：在消息传递阶段同时更新原子与键的表征，保持几何等变性。
5. **新的评估指标体系**：针对三维生成任务，引入关注类药性、几何合理性和化学有效性的综合指标，用以更全面评估模型性能。

# 3. 方法

本节介绍3D分子扩散模型的核心流程，包括前向与反向过程（3.1节）、E(3)-等变模型骨干结构（3.2节）、新的噪声调度方案（3.3节）及键引导的3D分子生成（3.4节）。

## 3.1. 3D分子扩散框架

**符号说明：**
 一个3D分子由原子类型、原子坐标和化学键信息构成，表示为
 $$M = {A, R, B},$$
 其中：

- $A = \{ a_i \}_N \in \mathbb{A}^N$：原子类型；
- $R = \{ \mathbf{r}_i \}_N \in \mathbb{R}^{N \times 3}$：原子位置；
- $B = \{ b_{ij} \}_{N \times N} \in \mathbb{B}^{N \times N}$：键类型。

我们选取7种元素（C, N, O, F, P, S, Cl）和5种键类型（单、双、三、芳香及虚拟类型 none-type）。氢原子未显式建模，可由其他原子推断。

### 3.1.1. 前向过程

扩散模型定义两个马尔可夫过程：前向过程逐步向数据添加噪声，反向过程则学习去噪以还原分布。

令上标 $t$ 表示时间步 $t(t = 0, 1, \dots, T)$ 处的变量，$M^0$ 表示真实分布中的3D分子。$M^t$ 仅在 $M^{t-1}$ 条件下从分布 $q(M^t|M^{t-1})$ 采样。对于原子类型和键类型，由于两者都是离散的，我们将其表示为分类分布。前向过程公式化如下：

$$
\begin{aligned}
q(\mathbf{r}_i^t|\mathbf{r}_i^{t-1}) &:= \mathcal{N}(\mathbf{r}_i^t | \sqrt{1 - \beta^t} \mathbf{r}_i^{t-1}, \beta^t \mathbf{I}) \\
q(a_i^t|a_i^{t-1}) &:= \mathcal{C}(a_i^t | (1 - \beta^t) a_i^{t-1} + \beta^t \mathbb{1}_k) \\
q(b_{ij}^t|b_{ij}^{t-1}) &:= \mathcal{C}(b_{ij}^t | (1 - \beta^t) b_{ij}^{t-1} + \beta^t \mathbb{1}_k),
\end{aligned}
$$

其中 $\beta^t \in [0, 1]$ 是预定义的噪声缩放调度，$\mathbf{I} \in \mathbb{R}^{3\times3}$ 是单位矩阵，$\mathbb{1}_k$ 表示第 $k$ 位为 1、其余所有位为 0 的 one-hot 向量。原子位置加高斯噪声，原子和键类型采用分类扰动逐步吸收至“吸收类型”中。原子类型新增一类吸收类型，键类型直接使用 none-type 作为吸收类型。这种离散化处理较连续高斯扰动表现更自然且性能更优。注意，在式1中，原子类型、原子位置和键类型的预定义噪声缩放 $\beta^t$ 可以不同，但为了清晰起见，我们在方程中未区分它们。

通过利用马尔可夫性质，$M^t$ 可以直接从原始样本 $M^0$（即，$q(M^t|M^0)$）基于式1导出。如果我们定义 $\alpha^t := 1 - \beta^t$ 且 $\bar{\alpha}^t := \prod_{s=1}^{t} \alpha^s$，则样本 $M^t$ 可推导为：

$$
\begin{aligned}
q(\mathbf{r}_i^t|M^0) &= \mathcal{N}(\mathbf{r}_i^t | \sqrt{\bar{\alpha}^t} \mathbf{r}_i^0, (1 - \bar{\alpha}^t) \mathbf{I}) \\
q(a_i^t|M^0) &= \mathcal{C}(a_i^t | \bar{\alpha}^t a_i^0 + (1 - \bar{\alpha}^t) \mathbb{1}_k) \\
q(b_{ij}^t|M^0) &= \mathcal{C}(b_{ij}^t | \bar{\alpha}^t b_{ij}^0 + (1 - \bar{\alpha}^t) \mathbb{1}_k).
\end{aligned}
$$

$\bar{\alpha}^t$ 的值可以解释为在步骤$t$时仍保留了多少来自真实数据的信息。我们称 $\bar{\alpha}^t$ 为信息水平，它可以通过噪声水平 $\beta^t$ 确定（我们将在第3.3节中讨论如何选择它们）。

当 $t \to \infty$ 时，根据式2，我们得到 $q(a_i^t|M^0) \to \mathbb{1}_k$，$q(\mathbf{r}_i^t|M^0) \to \mathcal{N}(\mathbf{0}, \mathbf{I})$，$q(b_{ij}^t|M^0) \to \mathbb{1}_k$，这表明对于较大的 $T$，原子位置近似服从标准高斯分布，而原子和键类型将所有概率质量置于吸收类型上。这些分布被称为先验分布，将作为反向过程的起始分布。

### 3.1.2. 反向过程

在反向过程中，我们逆转马尔可夫链，从先验分布逐步重构真实分子结构。转移分布 $p_\theta(M^{t-1}|M^t)$ 由 **E(3)-等变神经网络** 参数化，用于预测上一步的分子状态。具体而言：

- 原子位置建模为高斯分布：$\mathcal{N}(\mathbf{r}_i^{t-1} | \boldsymbol{\mu}_\theta(M^t, t), \Sigma^t)$
- 原子类型建模为分类分布：$\mathcal{C}(a_i^{t-1} | H_\theta(M^t, t))$
- 键类型建模为分类分布：$\mathcal{C}(b_{ij}^{t-1} | H'*\theta(M^t, t))$

其中 $\boldsymbol{\mu}_\theta$、$H_\theta$、$H'_\theta$ 为神经网络输出，且协方差 $\Sigma^t$ 固定为 $\beta^t$。

在训练阶段，我们对真实分子样本 $M^0$ 添加噪声生成 $M^t$，并训练网络去近似真实后验分布 $q(M^{t-1}|M^t, M^0)$，
即学习从噪声状态 $M^t$ 还原到上一状态 $M^{t-1}$。此处，$M^{t-1}$和$M^t$均在前向过程中收集。

损失函数定义为：



$$
L^{t-1} = L^{t-1}_{\text{pos}} + \lambda_1 L^{t-1}_{\text{atom}} + \lambda_2 L^{t-1}_{\text{bond}}
$$

其中，

$$
\begin{aligned}
L^{t-1}_{\text{pos}} &= \frac{1}{N} \sum_i \| \mathbf{r}_i^{t-1} - \boldsymbol{\mu}_\theta(M^t, t)_i \|_2^2 \\
L^{t-1}_{\text{atom}} &= \frac{1}{N} \sum_i D_{\text{KL}}[q(a_i^{t-1}|M^t, M^0) \| p_\theta(a_i^{t-1}|M^t)] \\
L^{t-1}_{\text{bond}} &= \frac{1}{N^2} \sum_{ij} D_{\text{KL}}[q(b_{ij}^{t-1}|M^t, M^0) \| p_\theta(b_{ij}^{t-1}|M^t)],
\end{aligned}
$$

 $\lambda_1$、$\lambda_2$ 为平衡权重。训练时随机采样时间步 $t$，最小化损失 $L^{t-1}$ 以优化网络参数 $\theta$。训练完成后，为了生成新分子，我们首先从先验分布 $p(M^T)$ 中采样 $M^T$，然后从 $p_\theta(M^{t-1}|M^t)$ 中反复采样，对于 $t=T, T-1, \dots, 1$，逐步去除噪声。先验分布$p(M^T)$是原子位置的标准高斯分布$\mathcal{N}(\mathbf{0}, \mathbf{I})$，以及原子类型和键类型的分类分布，其所有概率质量集中在吸收类型上。

## 3.2. 等变图神经网络

神经网络在建模3D分子时应具备的一个重要特性是E(3)-等变性，即网络的输出应对任何3D旋转、平移和反射保持等变。先前的模型EDM利用了E(3)-等变网络EGNN（Satorras等，2021b），通过在原子间传递消息来更新原子表示。然而，由于我们关注的是涉及原子和键的原子-键不一致性问题，我们需要设计一种新的等变网络架构和消息传递算法。形式上，对于输入分子 $M = \{\{a_i\}_N, \{\mathbf{r}_i\}_N, \{b_{ij}\}_{N\times N}\}$，我们构建一个完整的图，其顶点为原子且所有顶点相互连接。我们使用记号 $\mathbf{v}_i \in \mathbb{R}^d$ 和 $\mathbf{e}_{ij} \in \mathbb{R}^d$ 分别表示顶点 $i$ 和边 $(i,j)$ 的隐藏表示。输入特征是原子类型的 one-hot 编码，输入边特征是键类型的 one-hot 编码。然后，向量 $\mathbf{v}_i$、$\mathbf{e}_{ij}$ 和坐标 $\mathbf{r}_i$ 的更新定义如下：

$$
\begin{aligned}
\tilde{\mathbf{e}}_{ij} &\leftarrow \phi_d(\mathbf{e}_{ij}, \|\mathbf{r}_i - \mathbf{r}_j\|_2) \\
\mathbf{v}_i &\leftarrow \text{Linear}(\mathbf{v}_i) + \sum_j \phi_v(\mathbf{v}_j, \tilde{\mathbf{e}}_{ij}, t) \\
\mathbf{e}_{ij} &\leftarrow \sum_k \phi_e(\mathbf{v}_k, \tilde{\mathbf{e}}_{ki}, t) + \sum_k \phi_e(\mathbf{v}_k, \tilde{\mathbf{e}}_{jk}, t) \\
&\quad + \text{Linear}(\mathbf{v}_i) + \text{Linear}(\mathbf{v}_j) + \text{Linear}(\tilde{\mathbf{e}}_{ij}) \\
\mathbf{r}_i &\leftarrow \mathbf{r}_i + \sum_j \phi_r(\mathbf{v}_i, \mathbf{v}_j, \tilde{\mathbf{e}}_{ij}, t) \frac{\mathbf{r}_i - \mathbf{r}_j}{\|\mathbf{r}_i - \mathbf{r}_j\|_2^2},
\end{aligned}
$$

其中，$\text{Linear}(\cdot)$ 表示对输入的线性变换，而 $\phi_d, \phi_v, \phi_e, \phi_r$ 是由不同的多层感知机（MLPs）构成的神经网络。与先前模型（例如EGNN）的主要区别在于，我们强调了边的重要性。边也会与其他边和节点传播消息以更新其表示。该模型专门为本扩散框架设计，其中节点和边的特征均用于预测原子和键类型。经过多轮更新后，我们将坐标 $\mathbf{r}_i$ 作为原子位置预测均值 $\boldsymbol{\mu}_\theta$，并应用另外两个 MLP 后接 Softmax 激活函数，将特征向量 $\mathbf{v}_i$ 和 $\mathbf{e}_{ij}$ 转换为原子和键类型的概率：

$$
\begin{aligned}
p(a_i^{t-1}|M^t) &= \mathcal{C}(a_i | \text{softmax}(\text{MLP}(\mathbf{v}_i))) \\
p(b_{ij}^{t-1}|M^t) &= \mathcal{C}(b_{ij} | \text{softmax}(\text{MLP}(\mathbf{e}_{ij} + \mathbf{e}_{ji}))).
\end{aligned}
$$

注意，键类型 $b_{ij}$ 由边特征 $\mathbf{e}_{ij}$ 和 $\mathbf{e}_{ji}$ 共同决定，以保证对称性。

## 3.3. 原子与键噪声调度

在3D分子的扩散生成中存在一个独特因素。由于分子中的键类型与原子距离和原子类型密切相关，如果键类型使用与原子类型和原子位置相同的噪声调度，带噪数据分布将因原子与键的不一致性而受损。更具体地说，随着分子中加入更多噪声，原本形成化学键的原子对之间的距离很容易偏离键长，因此无需再进一步扰动这些键。例如，若分子中两个碳原子形成单键，在扩散过程中它们的距离极有可能变得大于 3Å，从而无法形成任何化学键。在这种情况下，要求神经网络学习“两个相距如此之远的原子可以形成单键”是毫无意义的。更正式地，真实分子的分布 $p(M) = p(A, R, B)$ 可分解为 $p(M) = p(A, R)p(B|A, R)$。对于任何扩散步骤 $t$，条件分布 $p(B^t|A^t, R^t)$ 可能与真实分布 $p(B^0|A^0, R^0)$ 大幅偏离。因此，中间分子 $M^t = (A^t, R^t, B^t)$ 包含偏向的原子与键关系。

为解决此问题，我们提出一种新扩散策略：将键与原子的扩散过程分离，并将前向扩散过程划分为两个阶段。在第一阶段，我们使键类型扩散至先验分布，所有键逐渐变为吸收类型。在此阶段，原子类型和位置仅被轻微扰动。请注意，重要的是向原子类型和位置注入少量噪声，而非固定它们并仅学习恢复键。通过这种方式，模型变得更加鲁棒，并能习得知识：当两个原子间的距离处于特定范围内时，需要添加化学键，而非一个固定值。在下一时间步，模型还可以学习调整原子坐标以满足基于刚刚恢复的键所施加的化学约束。在第一阶段结束时，几乎所有键都被标记为 none-type 并达到先验分布。

在第二阶段，我们继续扰动原子类型和位置，直至其到达相应的先验分布。由于在此阶段原子位置已发生巨大变化，分子中不再存在真实的化学键是合理的，因此模型专注于学习原子类型和位置。总体而言，该策略在扩散过程中保持了键与原子间的关系更接近真实情况。

![image-20251030102041380](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251030102041380.png)

我们通过设计一种新的键与原子噪声调度来实现这一点。如图2(a)所示，我们为原子（类型和位置）和键类型设置不同的 $\beta^t$，使得键类型的 $\bar{\alpha}^t$ 信息水平比原子在扩散过程中更快衰减至零。在第一阶段，原子仅被轻微扰动，模型更关注去噪键类型。在第二阶段，几乎所有真实键都已被移除，模型仅专注于原子的预测。通过这种方式，当原子距离明显偏离规范键长时，模型无需学习键类型。

### A.4 关于噪声调度的细节

余弦噪声调度是一种流行的调度方案，它使用余弦函数定义 $\bar{\alpha}^t$ 的调度，并且相比其他调度方案能取得更好的性能。然而，余弦调度仅有一个可调超参数，因此很难调整其曲线的形状和范围。我们定义了一种新的调度方案，该方案利用 sigmoid 函数，并拥有三个可调超参数 $s_1$、$s_T$、$w$ 来调整调度曲线。该调度方案定义如下：

$$
\begin{aligned}
s &= (s_T - s_1) / (\text{sigmoid}(-w) - \text{sigmoid}(w)) \\
b &= 0.5 \times (s_1 + s_T - s) \\
\bar{\alpha}_t &= s \times \text{sigmoid}(-w(2t/T - 1)) + b.
\end{aligned}
$$

参数 $s_1$ 和 $s_T$ 分别表示 $\bar{\alpha}_1$ 和 $\bar{\alpha}_T$ 的值，用于控制噪声的范围。参数 $w$ 影响中段的斜率，并控制 $\bar{\alpha}_t$ 在扩散过程开始和结束时变化的快慢。我们在图 5 中展示了参数 $w$ 如何影响曲线的形状。

![image-20251031104405944](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251031104405944.png)

在我们的实现中，对于原子类型和原子位置，在整个扩散过程 $t \in [1, T]$ 中，我们选择了参数 $s_1 = 0.9999$、$s_T = 0.0001$、$w = 3$。对于键类型，在第一阶段的扩散步骤 $[1, 600]$ 中，我们使用 $s_1 = 0.9999$、$s_T = 0.001$、$w = 3$；在第二阶段的步骤 $[600, 1000]$ 中，我们使用 $s_1 = 0.001$、$s_T = 0.0001$、$w = 2$。MolDiff 的曲线如图 6 所示。

![image-20251031104511736](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251031104511736.png)

## 3.4. 键预测器引导

如图1(d)所示，真实化学键的长度处于一个非常小的范围内。例如，氮-氧单键具有约 1.35Å 的规范长度，且很少低于 1.31Å 或高于 1.39Å。如果生成模型要生成一对 N-O 原子对，其距离为 1.25Å，则模型应固定原子位置，使键长落入N-O键的正确距离范围内。因此，我们还可以利用键类型与键长之间强关联的优势，来引导原子位置的生成，从而使我们的模型能够将原子放置在正确的位置，进而生成准确的3D分子结构。

为实现这一目标，我们训练另一个等变图神经网络 $F(A^t, R^t, t)$，它以原子类型和位置为输入，并预测分子的所有键，即一个基于神经网络的全键预测器。假设键类型的预测 logits 为 $F(A^t, R^t, t)_{ij}$，我们定义一个函数 $c[F(A^t, R^t, t)_{ij}]$ 来量化对键 $(i,j)$ 预测的置信度。基于所有原子对 $\{A, R\}$ 的置信度为：

$$
C(A^t, R^t, t) = \prod_{ij} c[F(A^t, R^t, t)_{ij}]
$$

如果采样的原子位置不准确，则键预测器的置信度 $C(A^t, R^t, t)$ 会很低，反之亦然。然后，$\log C(A^t, R^t, t)$ 相对于 $R^t$ 的梯度为我们提供了改进置信度并从而引导原子位置确定的方向。形式上，在引导下，原子位置的反向生成 $p_\theta(\mathbf{r}_i^{t-1}|M^t)$ 可重新表述为：

$$
\mathcal{N}\left( \mathbf{r}_i^{t-1} \middle| \boldsymbol{\mu}_\theta(M^t, t) + s \nabla \log C(A^t, R^t, t), \Sigma^t \right)
$$

其中 $s$ 是一个超参数，设为$1 \times 10^{-4}$。

该直觉源于扩散生成模型中的分类器引导（Dhariwal & Nichol, 2021），其中分类器用于引导生成样本以优化特定属性。但在此处，我们并非使用键预测器来改善某个特定属性，而是希望提高键预测器的置信度——这等价于生成更精确的键长，从而得到更精确的原子位置。键预测器 $F(A^t, R^t, t)$ 需要单独训练。为了适应带噪分子，我们训练键预测器，使其以带噪原子类型 $A^t$、带噪原子位置 $R^t$ 和步骤 $t$ 为输入，然后预测真实的键类型 $B^0$。

现在我们讨论置信度函数 $c[F(A^t, R^t, t)_{ij}]$ 的选择。如果分类器的输出是 logits，则分类分布的指数 logits 可被视为其共轭分布Dirichlet分布的参数（Malinin & Gales, 2018）。因此，预测的不确定性可以从 logits 推导出来，而置信度函数被定义为不确定性的倒数。如果我们用 $y$ 表示 $F(A^t, R^t, t)_{ij}$，则置信度函数为：

$$
c(y) = \sum_k \exp(y_k) + 1
$$

其中 $y_k$ 是第 $k$ 种类型的 logit。

# 4. 结果

我们首先在4.1节中比较了MolDiff与多个基线模型的生成能力。在4.2节中，我们将比较扩展到多个新指标，这些指标在以往的3D分子生成任务中通常被忽略。最后，我们通过消融研究（4.3节）和模型分析（4.4节）来分析我们设计的有效性，并探索每个组件的贡献。

## 4.1. 生成能力

**数据集**：我们使用 **GEOM-Drug** 数据集训练和评估我们的模型，数据预处理的详细信息见附录B。为了更好地反映真实的药物设计场景，我们仅考虑包含主要元素（C, N, O, F, P, S, Cl）的分子，并排除了氢原子。然而，我们也进行了额外的评估，纳入了次要元素类型（B, Br, I, Si, Bi）或仍保留氢原子的情况；此外，我们在另一个广泛使用的 QM9 数据集上与更多基线模型进行了比较，相关细节在附录D中进一步阐述。

**基线模型与设置**：我们将 MolDiff 与 EDM 及我们 MolDiff 模型的多个变体进行了比较。EDM 是首个用于 3D 分子生成的扩散模型，它对原子类型和位置应用连续扩散，并在后处理阶段使用查找表添加键类型。为了突出键在扩散模型中的重要性，我们提供了三个不涉及在扩散过程中预测键的 MolDiff 变体，它们在生成原子后采用三种不同策略预测键：1) 使用查找表（与EDM相同），2) 采用另一个神经网络作为键预测器，3) 采用化学工具包Open Babel。我们还提供了另外两个 MolDiff 变体，它们使用连续嵌入对原子和键类型进行编码，以展示与离散嵌入相比的性能差异。其中一个变体实现了 EDM 的策略，即在连续特征上增加额外的缩放。此外，我们提供了一个基线模型，该模型增加了一个额外的损失项以最小化预测键长与真实键长之间的差异——这是一种看似自然且简单的方法，旨在生成更好的键长。对于每个模型，我们采样了1000个有效且完整的3D分子，并重复此过程三次。

**指标**：我们定义了三个指标来评估模型的基本学习能力：(1) **有效性（Validity）**：在所有生成分子中可被RDKit解析的有效分子的比例；(2) **连通性（Connectivity）**：在所有有效分子中所有原子均相连的完整分子的比例；(3) **成功率（Success rate）**：在所有生成分子中既是有效又是完整分子的比例，其数值等于有效性乘以连通性。这三个指标是最重要的，因为它们衡量模型是否学习了分子的基本化学规则，如化合价约束和分子完整性。接下来，在有效且完整的分子中，我们从四个方面测量相似性：(1) **新颖性（Novelty）**：在训练集中不存在的生成分子的比例；(2) **多样性（Diversity）**：所有生成分子对之间的平均分子指纹相似度；(3) **唯一性（Uniqueness）**：在所有生成分子中唯一分子的比例；(4) **与验证集的相似性（Similarity with validation set）**：生成分子与验证集分子之间的平均相似度。

![image-20251029204348285](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251029204348285.png)

![image-20251031105929195](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251031105929195.png)

比较结果如表1所示。在有效性、连通性和成功率方面，MolDiff大幅优于EDM，表明MolDiff更好地捕捉了3D分子的化学约束。此外，MolDiff的成功率接近于1，表明几乎所有生成的分子都是完整且有效的，因此MolDiff已准备好应用于实际下游任务。与其他MolDiff变体相比，我们发现扩散过程中排除键会损害模型的学习和生成能力。表1还表明，在离散空间中扩散原子和键类型比在连续空间中表现更好。将键长作为额外损失项添加也未能提升性能，一个可能的原因是它可能损害了扩散过程中对带噪位置的学习。

在有效分子中，MolDiff在多样性和与验证集的相似性方面超越了EDM及所有MolDiff变体，表明MolDiff不仅生成了更多样化的分子，而且生成的分子也更接近真实分子。至于新颖性和唯一性，MolDiff并未达到最佳值，但其数值足够好，因为两者均接近于1。总体而言，我们得出结论：MolDiff比EDM具有更好的学习和生成能力，而在扩散过程中将原子/键类型视为离散变量是生成3D分子的必要组成部分。

## 4.2. 3D 分子的质量

上述指标仅关注生成的分子是否合理或多样。在此，我们深入探讨与3D几何结构和化学性质相关的分子质量。这些指标对于被选为药物候选物并用于实际世界应用的采样分子至关重要。我们从四个方面分析了EDM和MolDiff的有效且完整的分子：类药性、3D结构、键和环。

![image-20251029204410768](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251029204410768.png)

![image-20251031105950273](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251031105950273.png)

**类药性（Drug-likeness）**

我们使用以下指标评估生成分子的类药性：(1) QED是定量估计类药性的缩写；(2) SA代表合成可及性分数（数值越高表示越易于合成）；(3) Lipinski衡量分子遵循Lipinski五规则的程度（详细信息见附录C.2）。如表2所示，MolDiff在各项指标上均大幅优于EDM，表明MolDiff生成的分子是更好的药物候选物。

**3D结构（3D structures）**

3D分子生成与2D分子生成的一个主要区别在于原子位置的确定，因此有必要衡量其准确性。首先，我们计算了生成的3D分子与RDKit工具包预测的100种可能构象之间的最小RMSD（均方根偏差）。接着，我们选取了验证集中最频繁出现的键、键对和键三元组（具体类型见附录C.2）。我们计算了生成分子与验证集中分子的键长、键角和二面角。然后，我们使用Jensen-Shannon (JS) 散度来衡量生成分子与验证集分子分布之间的差异。如表2所示，MolDiff的RMSD更低，键角和二面角的JS散度也更低，表明MolDiff生成的分子3D结构更接近真实情况。我们还注意到，MolDiff在键长的JS散度方面表现较差。这并不令人意外，因为EDM通过查找表比较键长，使其键长更接近规范长度。但总体而言，MolDiff更好地捕捉了分子中3D信息的纠缠关系，优于EDM。

**键（Bonds）**

由于我们在生成过程中特别关注键信息，此处我们分析了生成分子的键相关属性。首先，我们通过比较生成分子与验证集中每个原子的键数分布，分析模型是否生成了过多或过少的键。其次，我们分析了不同键类型的分布，包括基本键类型（单键、双键、三键和芳香键）以及频繁的键对、键三元组，这些都用于3D结构的评估。如表2所示，MolDiff在所有分布上的JS散度均低于EDM，表明MolDiff生成的分子不仅具有更真实的计数，而且在不同类型键之间的比例也更为均衡。

**环（Rings）**

错误的键生成会违反分子的图拓扑结构，并容易导致有偏的环分布。例如，添加不必要的键会导致冗余或不现实的环。因此，我们将分析进一步扩展到环。首先，我们比较了生成分子与验证集中每个分子环数的分布。接着，我们比较了生成分子与验证集中$n$-元环数量的分布，并对$n \in \{3, 4, \dots, 9\}$取平均JS散度。真实分子通常含有大量6元环，但很少有大环或小环，因此我们希望检查该模型是否学习了这些潜在的设计原则。最后，我们找出了验证集中最常见的十种环类型，分别计算了验证集和生成分子中存在的高频环的数量。如表2所示，MolDiff在环数和$n$-元环分布上产生了更好的结果。关于环类型，MolDiff生成了更现实的环。我们还在图3中展示了验证集中最频繁出现的十种环，以及由EDM和MolDiff生成的环，其中可以明显看出，EDM生成的大多数环由于错误的键而显得不现实，而MolDiff生成的环则与验证集中的环相似。

## 4.3. 噪声调度与引导的分析

![image-20251029204635691](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251029204635691.png)

![image-20251031110021583](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251031110021583.png)

为了研究不同组件的重要性，我们进行了一项消融研究，以展示引导和特殊噪声调度的有效性。我们将完整的MolDiff模型与三个变体进行了比较：(1) 不使用键预测器引导的模型；(2) 不使用新提出的噪声调度的模型；以及 (3) 同时不使用这两种技术的模型。表3表明，引导和新的噪声调度都能极大地提升3D结构的确定性。

这两种策略也有助于生成更符合现实的键数量分布。我们还发现，它们对平衡不同类型键的比例没有影响。另一个观察结果是，这两种策略都有利于环的数量和不同类型环的排列。因此，我们得出结论：键预测器的引导和新的噪声调度是生成具有更好3D结构以及更优键和环分布分子的必要组成部分。此外，我们发现这两种策略并未损害基本指标（如生成能力和类药性），如附录C.3所示。

## 4.4. 模型分析

![image-20251029204907529](./MolDiff%20Addressing%20the%20Atom-Bond%20Inconsistency%20Problem%20in%203D%20Molecule%20%20Diffusion%20Generation.assets/image-20251029204907529.png)

最后，我们探讨了噪声调度和引导是如何发挥作用的。如前所述，新的噪声调度更早地扩散键类型，以避免在扩散过程中原子与键之间出现不合理的关系。我们首先计算了验证集中真实分子键长的范围，然后统计了在扩散过程的不同步骤中，键长超出该范围的真实键的数量。如图4(a)所示，MolDiff的噪声调度导致超出范围的键要少得多。实际上，这些键在当前时刻是不必要的，因此MolDiff的噪声调度使模型能够专注于更有意义的数据分布。

至于键预测器引导的作用，我们在图4(b)-(d)中展示了一个示例，说明它如何引导位置的生成。我们沿y轴扰动了数据集中一个分子的某个原子的位置（图4(b)），并计算了值$\log C(A, R, 0)$及其相对于扰动的缩放梯度（图4(c,d)）。我们发现，随着原子偏离其真实位置，置信度值会下降，梯度也会偏离零。因此，置信度函数的梯度有助于将原子推向正确的位置。

总之，噪声调度和引导共同促进了MolDiff更好地学习和生成具有更精确3D结构以及更符合现实的键和环分布的分子。

# 5. 结论

在本工作中，我们提出了一种3D分子生成模型，可同时处理分子中原子和键的生成。实验结果表明，该模型显著提升了生成能力和所生成分子的质量。未来的工作可以探索更复杂的噪声调度和更先进的引导策略，并分析其在下游实际任务中的潜力。